#lp17 : Apriori
import pandas as pd
from mlxtend.frequent_patterns import apriori, association_rules
from mlxtend.preprocessing import TransactionEncoder

# Step 1: Data Preprocessing
# Load the dataset
df = pd.read_csv('./Datasets/Oder3.csv')

# Generate transactions by grouping items by TransactionNo
transactions = df.groupby('TransactionNo')['Items'].apply(list).tolist()

# Step 2: Prepare the data for the Apriori algorithm
# Convert transactions into a one-hot encoded format
te = TransactionEncoder()
te_ary = te.fit_transform(transactions)
df = pd.DataFrame(te_ary, columns=te.columns_)

# Step 3: Apply the Apriori Algorithm
# Set minimum support to find frequent itemsets (example: 0.02)
frequent_itemsets = apriori(df, min_support=0.02, use_colnames=True)
# print("\nFrequent Itemsets : \n",frequent_itemsets)

# Step 4: Apply Association Rules
# Apply the association rules with a minimum lift threshold of 1.
# Remove num_itemsets=None if error comes here , it is due to version of mlxtend
rules = association_rules(frequent_itemsets, metric="confidence", min_threshold=0.30, num_itemsets=None)
print(rules[['antecedents', 'consequents', 'support', 'confidence', 'lift']])